{% extends "base_template.html" %}

{% block title %}Setup Two-Factor Authentication{% endblock %}

{% block content %}

<h1 class="h2 mb-3"><b>Setup Two-Factor Authentication</b></h1>

<div class="row">
    <div class="col-12 col-md-8">

        <div class="mb-3">
            <nav aria-label="Progress">
                <ol class="breadcrumb" id="progress-steps">
                    <li class="breadcrumb-item active" id="step1-indicator">
                        <strong>Step 1:</strong> Scan QR Code
                    </li>
                    <li class="breadcrumb-item" id="step2-indicator">
                        Step 2: Verify Code
                    </li>
                    <li class="breadcrumb-item" id="step3-indicator">
                        Step 3: Save Backup Codes
                    </li>
                </ol>
            </nav>
        </div>

        <div id="step1" class="step-content">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="card-title">Scan QR Code</h3>
                    <p class="card-text">Scan this QR code with your authenticator app (Google Authenticator, Authy, Microsoft Authenticator, etc.)</p>

                    <div class="text-center mb-3">
                        <img src="{{ qr_code }}" alt="QR Code" class="img-fluid" style="max-width: 300px;">
                    </div>

                    <div class="alert alert-info">
                        <strong>Manual Entry:</strong> If you can't scan the QR code, enter this secret key manually:
                        <div class="mt-2">
                            <code class="fs-5">{{ secret }}</code>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fa fa-exclamation-triangle"></i> <strong>Important:</strong> Do not close this window until you complete all steps.
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <button class="btn btn-primary" onclick="goToStep(2)">Continue to Step 2</button>
                <a href="{{ url_for('profile.my_profile') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </div>

        <div id="step2" class="step-content" style="display: none;">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="card-title">Verify Your Code</h3>
                    <p class="card-text">Enter the 6-digit code from your authenticator app to verify the setup.</p>

                    <div id="error-message" class="alert alert-danger" style="display: none;"></div>

                    <form id="verify-form" onsubmit="return verifyCode(event);">
                        <div class="row">
                            <div class="col-md-6 col-lg-6 col-xs-12">
                                <div class="mb-3">
                                    <label for="token" class="form-label">Verification Code</label>
                                    <input type="text" class="form-control form-control-lg" id="token" name="token"
                                           placeholder="000000" autocomplete="off" maxlength="6" pattern="[0-9]{6}" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <button type="submit" class="btn btn-primary" id="verify-btn" data-verify-url="{{ url_for('auth.verify_two_factor_setup') }}">
                                    <span id="verify-btn-text">Enable 2FA</span>
                                    <span id="verify-btn-spinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                                <a href="{{ url_for('profile.my_profile') }}" class="btn btn-outline-secondary">Cancel</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="step3" class="step-content" style="display: none;">
            <div class="alert alert-success mb-4">
                <i class="fa fa-check-circle"></i> <strong>Success!</strong> Two-factor authentication has been enabled for your account.
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="card-title">Save Your Backup Codes</h3>

                    <div class="alert alert-warning">
                        <i class="fa fa-exclamation-triangle"></i> <strong>Important:</strong> Save these backup codes in a secure location. Each code can only be used once.
                    </div>

                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <div class="row" id="backup-codes-list"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button class="btn btn-secondary" onclick="window.print()">
                            <i class="fa fa-print"></i> Print Codes
                        </button>
                        <button class="btn btn-secondary" onclick="downloadCodes()">
                            <i class="fa fa-download"></i> Download Codes
                        </button>
                    </div>

                    <div class="alert alert-info">
                        <strong>Note:</strong> You can regenerate backup codes at any time from your profile settings.
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <a href="{{ url_for('profile.my_profile') }}" class="btn btn-primary">
                    <i class="fa fa-check"></i> Complete Setup
                </a>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('profile.scripts') }}"></script>
{% endblock %}
